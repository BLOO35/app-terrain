<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Terrain</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body style="font-family: Arial; padding: 20px; background: #f5f5f5; margin: 0;">
    <div style="max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h1 style="text-align: center; color: #667eea;">üìã Application Terrain</h1>
        
        <div id="page0" style="display: block;">
            <h2 style="color: #333; margin-bottom: 20px; text-align: center;">S√©lection de votre zone</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">Choisissez votre zone de contr√¥le :</p>
            <button id="btnZoneParis" style="width: 100%; padding: 15px; margin: 10px 0; background: #667eea; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">Paris</button>
            <button id="btnZoneMarseille" style="width: 100%; padding: 15px; margin: 10px 0; background: #667eea; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">Marseille</button>
            <button id="btnZoneLyon" style="width: 100%; padding: 15px; margin: 10px 0; background: #667eea; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">Lyon</button>
        </div>
        
        <div id="page1" style="display: none;">
            <h2 style="color: #333; margin-bottom: 20px;">Page 1 - Informations g√©n√©rales</h2>
            <input type="text" id="nom" placeholder="Nom" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
            <input type="text" id="prenom" placeholder="Pr√©nom" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
            <input type="text" id="semaine" placeholder="Semaine" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
            <input type="text" id="client" placeholder="Client" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
            <input type="text" id="magasin" placeholder="Magasin" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
            <button id="btnBack1" style="width: 48%; padding: 15px; margin: 20px 1% 10px 0; background: #ddd; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">‚Üê Retour</button>
            <button id="btnNext" style="width: 48%; padding: 15px; margin: 20px 0 10px 0; background: #667eea; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">Suivant ‚Üí</button>
        </div>
        
        <div id="page2" style="display: none;">
            <h2 style="color: #333; margin-bottom: 20px;">Page 2 - Adresse et d√©tails</h2>
            <select id="ville" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">-- S√©lectionner ville --</option>
            </select>
            <input type="text" id="cp" placeholder="Code postal" readonly style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px; background: #f5f5f5;">
            <select id="rue" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">-- S√©lectionner rue --</option>
            </select>
            <input type="text" id="numero" placeholder="N¬∞ rue" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
            <select id="habitat" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">-- Type d'habitat --</option>
                <option value="Pavillon">Pavillon</option>
                <option value="Immeuble">Immeuble</option>
            </select>
            <input type="number" id="foyers" placeholder="Nombre de foyers" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
            <select id="acces" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">-- Type d'acc√®s --</option>
                <option value="Libre">Libre</option>
                <option value="Cl√© Pass">Cl√© Pass</option>
                <option value="Vigik">Vigik</option>
                <option value="Interphone">Interphone</option>
                <option value="Code">Code</option>
            </select>
            <select id="resultat" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">-- R√©sultat du contr√¥le --</option>
                <option value="Servi">Servi</option>
                <option value="Non servi">Non servi</option>
                <option value="Mal servi">Mal servi</option>
            </select>
            <select id="malservi" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">-- Si Mal servi --</option>
                <option value="D√©p√¥t">D√©p√¥t</option>
                <option value="Ciblage (Stop-pubs servi)">Ciblage (Stop-pubs servi)</option>
                <option value="Ciblage (HLM servi)">Ciblage (HLM servi)</option>
                <option value="Multidistribution">Multidistribution</option>
            </select>
            <select id="civilite" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">-- Civilit√© --</option>
                <option value="M.">M.</option>
                <option value="Mme">Mme</option>
                <option value="M. & Mme">M. & Mme</option>
            </select>
            <input type="text" id="resident" placeholder="Nom du r√©sident" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
            
            <div id="photoSection" style="margin: 15px 0; padding: 15px; background: #f9f9f9; border-radius: 5px; border: 1px solid #e0e0e0;">
                <h3 style="color: #667eea; margin-top: 0;">üì∏ Photo (optionnel)</h3>
                <input type="file" id="photoInput" accept="image/*" capture="environment" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <div id="photoPreview" style="margin-top: 10px;"></div>
            </div>
            
            <button id="btnBack2" style="width: 48%; padding: 15px; margin: 20px 1% 10px 0; background: #ddd; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">‚Üê Retour</button>
            <button id="btnSave" style="width: 48%; padding: 15px; margin: 20px 0 10px 0; background: #4caf50; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">‚úì Valider</button>
        </div>
        
        <div id="page3" style="display: none;">
            <h2 style="color: #333; margin-bottom: 20px;">Adresses collect√©es</h2>
            <div id="counter" style="text-align: center; font-size: 18px; font-weight: bold; color: #667eea; margin-bottom: 15px;">0 adresses</div>
            <div id="entries" style="margin-bottom: 20px;"></div>
            <button id="btnNew" style="width: 100%; padding: 15px; margin: 10px 0; background: #667eea; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">+ Nouvelle adresse</button>
            <button id="btnEndDay" style="width: 100%; padding: 15px; margin: 10px 0; background: #ff6b6b; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">üèÅ Fin de journ√©e</button>
        </div>
    </div>
    
    <script>
        emailjs.init('3LJ36I1SMDa4OfCoh');
        
        const dataZones = {
            'Paris': {
                codePostaux: {'Paris': '75000', 'Boulogne': '92100', 'Neuilly': '92200'},
                rues: {
                    'Paris': ['Rue Jean Moulin', 'Rue Gambetta', 'Rue Rivoli'],
                    'Boulogne': ['Avenue Paul Doumer', 'Boulevard Verdun'],
                    'Neuilly': ['Avenue Charles de Gaulle', 'Boulevard Maillot']
                }
            },
            'Marseille': {
                codePostaux: {'Marseille': '13000', 'Aix': '13100', 'Aubagne': '13400'},
                rues: {
                    'Marseille': ['Rue de la Canebi√®re', 'Boulevard Longchamp'],
                    'Aix': ['Cours Mirabeau', 'Rue Gaston Saporta'],
                    'Aubagne': ['Avenue de la Toison d\'Or', 'Rue Fonrouge']
                }
            },
            'Lyon': {
                codePostaux: {'Lyon': '69000', 'Villeurbanne': '69100', 'D√©cines': '69150'},
                rues: {
                    'Lyon': ['Rue de la R√©publique', 'Rue Childebert', 'Rue d\'Alg√©rie'],
                    'Villeurbanne': ['Boulevard de la R√©publique', 'Rue Thiers'],
                    'D√©cines': ['Rue Alsace Lorraine', 'Avenue Gaston Berger']
                }
            }
        };
        
        let entries = [];
        let page1Data = {};
        let currentPhoto = null;
        let currentZone = null;
        
        // S√©lection de zone
        document.getElementById('btnZoneParis').onclick = function() {
            selectZone('Paris');
        };
        document.getElementById('btnZoneMarseille').onclick = function() {
            selectZone('Marseille');
        };
        document.getElementById('btnZoneLyon').onclick = function() {
            selectZone('Lyon');
        };
        
        function selectZone(zone) {
            currentZone = zone;
            loadVilles(zone);
            document.getElementById('page0').style.display = 'none';
            document.getElementById('page1').style.display = 'block';
            window.scrollTo(0, 0);
        }
        
        function loadVilles(zone) {
            const villeSelect = document.getElementById('ville');
            villeSelect.innerHTML = '<option value="">-- S√©lectionner ville --</option>';
            
            const villes = Object.keys(dataZones[zone].codePostaux);
            villes.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                villeSelect.appendChild(opt);
            });
        }
        
        document.getElementById('photoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    currentPhoto = event.target.result;
                    const preview = document.getElementById('photoPreview');
                    preview.innerHTML = '<img src="' + currentPhoto + '" style="max-width: 100%; border-radius: 5px; margin-top: 10px;">';
                };
                reader.readAsDataURL(file);
            }
        });
        
        document.getElementById('btnBack1').onclick = function() {
            document.getElementById('page1').style.display = 'none';
            document.getElementById('page0').style.display = 'block';
            window.scrollTo(0, 0);
        };
        
        document.getElementById('btnNext').onclick = function() {
            const nom = document.getElementById('nom').value.trim();
            const prenom = document.getElementById('prenom').value.trim();
            const semaine = document.getElementById('semaine').value.trim();
            const client = document.getElementById('client').value.trim();
            const magasin = document.getElementById('magasin').value.trim();
            
            if (!nom || !prenom || !semaine || !client || !magasin) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            page1Data = {nom, prenom, semaine, client, magasin};
            document.getElementById('page1').style.display = 'none';
            document.getElementById('page2').style.display = 'block';
            window.scrollTo(0, 0);
        };
        
        document.getElementById('ville').onchange = function() {
            const ville = this.value;
            const rueSelect = document.getElementById('rue');
            const cp = document.getElementById('cp');
            
            rueSelect.innerHTML = '<option value="">-- S√©lectionner rue --</option>';
            cp.value = '';
            
            if (ville) {
                cp.value = dataZones[currentZone].codePostaux[ville];
                const rues = dataZones[currentZone].rues[ville];
                rues.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r;
                    opt.textContent = r;
                    rueSelect.appendChild(opt);
                });
            }
        };
        
        document.getElementById('btnBack2').onclick = function() {
            document.getElementById('page2').style.display = 'none';
            document.getElementById('page1').style.display = 'block';
            window.scrollTo(0, 0);
        };
        
        document.getElementById('btnSave').onclick = function() {
            const ville = document.getElementById('ville').value.trim();
            const rue = document.getElementById('rue').value.trim();
            const numero = document.getElementById('numero').value.trim();
            const habitat = document.getElementById('habitat').value.trim();
            const foyers = document.getElementById('foyers').value.trim();
            const acces = document.getElementById('acces').value.trim();
            const resultat = document.getElementById('resultat').value.trim();
            const civilite = document.getElementById('civilite').value.trim();
            const resident = document.getElementById('resident').value.trim();
            
            if (!ville || !rue || !numero || !habitat || !foyers || !acces || !resultat || !civilite || !resident) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            entries.push({
                numero: entries.length + 1,
                numero_rue: numero,
                rue: rue,
                ville: ville,
                codePostal: document.getElementById('cp').value,
                typeHabitat: habitat,
                nbrFoyers: foyers,
                typeAcces: acces,
                resultat: resultat,
                siMalServi: document.getElementById('malservi').value || '',
                civilite: civilite,
                nomResident: resident,
                photo: currentPhoto,
                zone: currentZone,
                ...page1Data
            });
            
            document.getElementById('page2').style.display = 'none';
            document.getElementById('page3').style.display = 'block';
            displayEntries();
            alert('Adresse enregistr√©e ! (' + entries.length + ' adresse(s))');
            
            window.scrollTo(0, 0);
        };
        
        function displayEntries() {
            let html = '';
            entries.forEach(e => {
                html += '<div style="background: #f0f0f0; padding: 12px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #667eea;">';
                html += '<strong style="color: #667eea;">#' + e.numero + ' - ' + e.numero_rue + ' ' + e.rue + '</strong><br>';
                html += '<small style="color: #666;">' + e.codePostal + ' ' + e.ville + '</small><br>';
                html += '<small style="color: #666;">' + e.typeHabitat + ' ¬∑ ' + e.nbrFoyers + ' foyer(s) ¬∑ R√©sultat: ' + e.resultat + '</small>';
                if (e.photo) {
                    html += '<br><small style="color: #667eea;">üì∏ Photo jointe</small>';
                }
                html += '</div>';
            });
            document.getElementById('entries').innerHTML = html;
            document.getElementById('counter').textContent = entries.length + ' adresse(s)';
        }
        
        document.getElementById('btnNew').onclick = function() {
            document.getElementById('rue').innerHTML = '<option value="">-- S√©lectionner rue --</option>';
            document.getElementById('numero').value = '';
            document.getElementById('habitat').value = '';
            document.getElementById('foyers').value = '';
            document.getElementById('acces').value = '';
            document.getElementById('resultat').value = '';
            document.getElementById('malservi').value = '';
            document.getElementById('civilite').value = '';
            document.getElementById('resident').value = '';
            document.getElementById('ville').value = '';
            document.getElementById('cp').value = '';
            document.getElementById('photoInput').value = '';
            document.getElementById('photoPreview').innerHTML = '';
            currentPhoto = null;
            
            document.getElementById('page3').style.display = 'none';
            document.getElementById('page2').style.display = 'block';
            window.scrollTo(0, 0);
        };
        
        document.getElementById('btnEndDay').onclick = function() {
            if (entries.length === 0) {
                alert('‚ö†Ô∏è Aucune adresse collect√©e !');
                return;
            }
            
            if (confirm('üìß Confirmer l\'envoi de ' + entries.length + ' adresse(s) ?')) {
                sendEmailAndExcel();
            }
        };
        
        function generateExcel() {
            const wsData = [
                ['Commune', 'N¬∞ rue', 'Nom rue', 'Code postal', 'Ville', 'Nombre de foyers', 'Type d\'acc√®s', 'Civilit√©', 'Nom', 'R√©sultat', 'Si Mal servi', 'Photo', 'Zone']
            ];
            
            entries.forEach((e, i) => {
                wsData.push([
                    e.ville,
                    e.numero_rue,
                    e.rue,
                    e.codePostal,
                    e.ville,
                    e.nbrFoyers,
                    e.typeAcces,
                    e.civilite,
                    e.nomResident,
                    e.resultat,
                    e.siMalServi,
                    e.photo ? 'Oui' : 'Non',
                    e.zone
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            ws['!cols'] = [{wch:15}, {wch:8}, {wch:25}, {wch:12}, {wch:15}, {wch:15}, {wch:15}, {wch:12}, {wch:20}, {wch:15}, {wch:25}, {wch:10}, {wch:12}];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Adresses');
            XLSX.writeFile(wb, 'adresses_collectees_' + currentZone + '.xlsx');
        }
        
        function sendEmailAndExcel() {
            let tableauTexte = '\n';
            tableauTexte += '========================================\n';
            tableauTexte += '     TABLEAU DES ADRESSES COLLECTEES\n';
            tableauTexte += '========================================\n\n';
            
            entries.forEach((e, i) => {
                tableauTexte += 'Adresse #' + (i+1) + '\n';
                tableauTexte += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
                tableauTexte += 'Commune : ' + e.ville + '\n';
                tableauTexte += 'N¬∞ rue : ' + e.numero_rue + '\n';
                tableauTexte += 'Nom rue : ' + e.rue + '\n';
                tableauTexte += 'Code postal : ' + e.codePostal + '\n';
                tableauTexte += 'Ville : ' + e.ville + '\n';
                tableauTexte += 'Nombre de foyers : ' + e.nbrFoyers + '\n';
                tableauTexte += 'Type d\'acc√®s : ' + e.typeAcces + '\n';
                tableauTexte += 'Civilit√© : ' + e.civilite + '\n';
                tableauTexte += 'Nom : ' + e.nomResident + '\n';
                tableauTexte += 'R√©sultat : ' + e.resultat + '\n';
                if (e.siMalServi) {
                    tableauTexte += 'Si Mal servi : ' + e.siMalServi + '\n';
                }
                if (e.photo) {
                    tableauTexte += 'Photo : Oui\n';
                }
                tableauTexte += '\n';
            });
            
            const today = new Date();
            const dateStr = today.toLocaleDateString('fr-FR', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const messageComplet = 'Bonjour,\n\n' +
                '=======================================\n' +
                '    RAPPORT DE COLLECTE DE TERRAIN\n' +
                '=======================================\n\n' +
                'Zone : ' + currentZone + '\n' +
                'Collecteur : ' + page1Data.nom + ' ' + page1Data.prenom + '\n' +
                'Semaine : ' + page1Data.semaine + '\n' +
                'Date du contr√¥le : ' + dateStr + '\n' +
                'Client : ' + page1Data.client + '\n' +
                'Magasin : ' + page1Data.magasin + '\n' +
                'Total d\'adresses : ' + entries.length + '\n' +
                tableauTexte +
                '\n=======================================\n' +
                'Fichier Excel joint au mail.\n' +
                'Cordialement,\n' +
                'Application Terrain';
            
            const templateParams = {
                to_email: 'amc@auditmediacom.com',
                from_name: page1Data.nom + ' ' + page1Data.prenom,
                subject: 'Rapport collecte - ' + currentZone + ' - ' + page1Data.client + ' - ' + page1Data.magasin + ' - ' + page1Data.nom + ' ' + page1Data.prenom + ' (' + entries.length + ' adresses)',
                message: messageComplet
            };
            
            emailjs.send('service_ryubxrp', 'template_ds6yn34', templateParams)
                .then(function(response) {
                    alert('‚úÖ Email envoy√© avec succ√®s !\nüì• T√©l√©chargement de l\'Excel...');
                    console.log('SUCCESS!', response.status, response.text);
                    
                    generateExcel();
                    
                    setTimeout(() => {
                        entries = [];
                        currentPhoto = null;
                        document.getElementById('page0').style.display = 'block';
                        document.getElementById('page3').style.display = 'none';
                        document.getElementById('page1').style.display = 'none';
                        document.getElementById('page2').style.display = 'none';
                        document.getElementById('nom').value = '';
                        document.getElementById('prenom').value = '';
                        document.getElementById('semaine').value = '';
                        document.getElementById('client').value = '';
                        document.getElementById('magasin').value = '';
                        window.scrollTo(0, 0);
                    }, 3000);
                }, function(error) {
                    alert('‚ùå Erreur lors de l\'envoi : ' + error);
                    console.log('FAILED...', error);
                });
        }
    </script>
</body>
</html>
