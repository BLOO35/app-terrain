<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Terrain</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body style="font-family: Arial; padding: 20px; background: #f5f5f5; margin: 0;">
    <div style="max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h1 style="text-align: center; color: #667eea;">Application Terrain</h1>
        
        <div id="page0" style="display: block;">
            <h2 style="color: #333; margin-bottom: 20px; text-align: center;">Selection de votre zone</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">Choisissez votre zone de controle :</p>
            <button id="btnZoneLouvroil" style="width: 100%; padding: 15px; margin: 10px 0; background: #667eea; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">Louvroil</button>
        </div>
        
        <div id="page1" style="display: none;">
            <h2 style="color: #333; margin-bottom: 20px;">Page 1 - Informations generales</h2>
            <input type="text" id="nom" placeholder="Nom" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
            <input type="text" id="prenom" placeholder="Prenom" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
            <input type="text" id="semaine" placeholder="Semaine" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
            <input type="text" id="client" placeholder="Client" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
            <input type="text" id="magasin" placeholder="Magasin" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
            <button id="btnBack1" style="width: 48%; padding: 15px; margin: 20px 1% 10px 0; background: #ddd; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">Retour</button>
            <button id="btnNext" style="width: 48%; padding: 15px; margin: 20px 0 10px 0; background: #667eea; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">Suivant</button>
        </div>
        
        <div id="page2" style="display: none;">
            <h2 style="color: #333; margin-bottom: 20px;">Page 2 - Adresse et details</h2>
            <select id="ville" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;"><option value="">-- Selectionner commune --</option></select>
            <select id="rue" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;"><option value="">-- Selectionner rue --</option></select>
            <input type="number" id="numero" placeholder="N° rue" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
            <select id="habitat" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;"><option value="">-- Type d'habitat --</option><option value="Pavillon">Pavillon</option><option value="Immeuble">Immeuble</option></select>
            <input type="number" id="foyers" placeholder="Nombre de foyers" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
            <select id="acces" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;"><option value="">-- Type d'acces --</option><option value="Libre">Libre</option><option value="Code">Code</option><option value="Interphone">Interphone</option></select>
            <select id="resultat" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;"><option value="">-- Resultat --</option><option value="Servie">Servie</option><option value="Non servie">Non servie</option><option value="Mal servie">Mal servie</option></select>
            <select id="malservi" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;"><option value="">-- Si Mal servie --</option><option value="Depot">Depot</option><option value="Ciblage">Ciblage</option></select>
            <select id="civilite" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;"><option value="">-- Civilite --</option><option value="M.">M.</option><option value="Mme">Mme</option></select>
            <input type="text" id="resident" placeholder="Nom du resident" style="width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px;">
            <input type="file" id="photoInput" accept="image/*" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
            <button id="btnBack2" style="width: 48%; padding: 15px; margin: 20px 1% 10px 0; background: #ddd; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">Retour</button>
            <button id="btnSave" style="width: 48%; padding: 15px; margin: 20px 0 10px 0; background: #4caf50; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">Valider</button>
        </div>
        
        <div id="page3" style="display: none;">
            <h2 style="color: #333; margin-bottom: 20px;">Adresses collectees</h2>
            <div id="counter" style="text-align: center; font-size: 18px; font-weight: bold; color: #667eea; margin-bottom: 15px;">0 adresses</div>
            <div id="entries" style="margin-bottom: 20px; overflow-x: auto;"></div>
            <button id="btnNew" style="width: 100%; padding: 15px; margin: 10px 0; background: #667eea; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">Nouvelle adresse</button>
            <button id="btnEndDay" style="width: 100%; padding: 15px; margin: 10px 0; background: #ff6b6b; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold;">Fin de journee</button>
        </div>
    </div>
    
    <script>
        var dataZones = {};
        dataZones.Louvroil = {};
        dataZones.Louvroil.rues = {};
        dataZones.Louvroil.rues["FERRIERE LA GRANDE"] = {"RUE DES CARRIERES":[{debut:1, fin:22}],"AVENUE DU MARECHAL FOCH":[{debut:1, fin:59}],"PLACE DE LA GARE":[{debut:1, fin:3}]};
        dataZones.Louvroil.rues["HAUTMONT"] = {"AVENUE DU GENERAL LECLERC":[{debut:1, fin:279}],"AVENUE GAMBETTA":[{debut:2, fin:36}]};
        dataZones.Louvroil.rues["LOUVROIL"] = {"AVENUE DE MONTFORT EN CHALOSSE":[{debut:1, fin:150}],"RUE JEAN JAURES":[{debut:12, fin:51}]};
        
        var entries = [];
        var page1Data = {};
        var currentPhoto = null;
        var currentZone = null;
        
        function initApp() {
            try { emailjs.init("3LJ36I1SMDa4OfCoh"); } catch(e) {}
            document.getElementById("btnZoneLouvroil").onclick = function() { selectZone("Louvroil"); };
            document.getElementById("btnBack1").onclick = function() { document.getElementById("page1").style.display = "none"; document.getElementById("page0").style.display = "block"; };
            document.getElementById("btnNext").onclick = function() {
                var nom = document.getElementById("nom").value.trim();
                var prenom = document.getElementById("prenom").value.trim();
                if (!nom || !prenom) { alert("Veuillez remplir tous les champs"); return; }
                page1Data = {nom: nom, prenom: prenom, semaine: document.getElementById("semaine").value.trim(), client: document.getElementById("client").value.trim(), magasin: document.getElementById("magasin").value.trim()};
                document.getElementById("page1").style.display = "none";
                document.getElementById("page2").style.display = "block";
            };
            document.getElementById("ville").onchange = function() {
                var rueSelect = document.getElementById("rue");
                rueSelect.innerHTML = "<option value=\"\">-- Selectionner rue --</option>";
                if (this.value && dataZones[currentZone].rues[this.value]) {
                    var rues = Object.keys(dataZones[currentZone].rues[this.value]);
                    for (var i = 0; i < rues.length; i++) {
                        var opt = document.createElement("option");
                        opt.value = rues[i];
                        opt.textContent = rues[i];
                        rueSelect.appendChild(opt);
                    }
                }
            };
            document.getElementById("btnBack2").onclick = function() { document.getElementById("page2").style.display = "none"; document.getElementById("page1").style.display = "block"; };
            document.getElementById("btnSave").onclick = function() {
                var commune = document.getElementById("ville").value.trim();
                var rue = document.getElementById("rue").value.trim();
                var numero = document.getElementById("numero").value.trim();
                var resultat = document.getElementById("resultat").value.trim();
                var civilite = document.getElementById("civilite").value.trim();
                var resident = document.getElementById("resident").value.trim();
                if (!commune || !rue || !numero || !resultat || !civilite || !resident) { alert("Veuillez remplir tous les champs"); return; }
                
                entries.push({numero_rue: numero, rue: rue, commune: commune, resultat: resultat, civilite: civilite, nomResident: resident});
                document.getElementById("page2").style.display = "none";
                document.getElementById("page3").style.display = "block";
                displayEntries();
                alert("Adresse enregistree : " + entries.length);
                document.getElementById("rue").innerHTML = "<option value=\"\">-- Selectionner rue --</option>";
                document.getElementById("numero").value = "";
                document.getElementById("resultat").value = "";
                document.getElementById("civilite").value = "";
                document.getElementById("resident").value = "";
            };
            document.getElementById("btnNew").onclick = function() {
                document.getElementById("ville").value = "";
                document.getElementById("rue").innerHTML = "<option value=\"\">-- Selectionner rue --</option>";
                document.getElementById("numero").value = "";
                document.getElementById("resultat").value = "";
                document.getElementById("civilite").value = "";
                document.getElementById("resident").value = "";
                document.getElementById("page3").style.display = "none";
                document.getElementById("page2").style.display = "block";
            };
            document.getElementById("btnEndDay").onclick = function() {
                if (entries.length === 0) { alert("Aucune adresse collectee"); return; }
                if (confirm("Confirmer envoi de " + entries.length + " adresse(s) ?")) {
                    this.disabled = true;
                    this.textContent = "Envoi en cours...";
                    sendEmail();
                }
            };
        }
        
        function selectZone(zone) {
            currentZone = zone;
            var villeSelect = document.getElementById("ville");
            villeSelect.innerHTML = "<option value=\"\">-- Selectionner commune --</option>";
            if (dataZones[zone] && dataZones[zone].rues) {
                var communes = Object.keys(dataZones[zone].rues);
                for (var i = 0; i < communes.length; i++) {
                    var opt = document.createElement("option");
                    opt.value = communes[i];
                    opt.textContent = communes[i];
                    villeSelect.appendChild(opt);
                }
            }
            document.getElementById("page0").style.display = "none";
            document.getElementById("page1").style.display = "block";
        }
        
        function displayEntries() {
            var html = "<table style=\"width: 100%; border-collapse: collapse; font-size: 12px;\">";
            html += "<tr style=\"background: #667eea; color: white; font-weight: bold;\"><td style=\"border: 1px solid #ddd; padding: 8px;\">N° rue</td><td style=\"border: 1px solid #ddd; padding: 8px;\">Adresse</td><td style=\"border: 1px solid #ddd; padding: 8px;\">Commune</td><td style=\"border: 1px solid #ddd; padding: 8px;\">Resultat</td><td style=\"border: 1px solid #ddd; padding: 8px;\">Nom</td></tr>";
            for (var i = 0; i < entries.length; i++) {
                var e = entries[i];
                var bgColor = (e.resultat === "Non servie" || e.resultat === "Mal servie") ? "#ffe0e0" : "white";
                html += "<tr style=\"background: " + bgColor + ";\"><td style=\"border: 1px solid #ddd; padding: 8px;\">" + e.numero_rue + "</td><td style=\"border: 1px solid #ddd; padding: 8px;\">" + e.rue + "</td><td style=\"border: 1px solid #ddd; padding: 8px;\">" + e.commune + "</td><td style=\"border: 1px solid #ddd; padding: 8px;\">" + e.resultat + "</td><td style=\"border: 1px solid #ddd; padding: 8px;\">" + e.civilite + " " + e.nomResident + "</td></tr>";
            }
            html += "</table>";
            document.getElementById("entries").innerHTML = html;
            document.getElementById("counter").textContent = entries.length + " adresse(s)";
        }
        
        function sendEmail() {
            var text = "\nN° rue | Adresse | Commune | Resultat | Nom du resident\n";
            for (var i = 0; i < entries.length; i++) {
                var e = entries[i];
                var mark = (e.resultat === "Non servie" || e.resultat === "Mal servie") ? "*** " : "";
                text += mark + e.numero_rue + " | " + e.rue + " | " + e.commune + " | " + e.resultat + " | " + e.civilite + " " + e.nomResident + "\n";
            }
            var msg = "Bonjour,\nZone: " + currentZone + "\nCollecteur: " + page1Data.nom + " " + page1Data.prenom + "\n" + text + "\nCordialement";
            emailjs.send("service_ryubxrp", "template_ds6yn34", {to_email: "amc@auditmediacom.com", from_name: page1Data.nom, subject: "Rapport collecte - " + currentZone, message: msg}).then(function() {
                alert("Email envoye");
                entries = [];
                document.getElementById("page0").style.display = "block";
                document.getElementById("page3").style.display = "none";
                document.getElementById("btnEndDay").disabled = false;
                document.getElementById("btnEndDay").textContent = "Fin de journee";
            });
        }
        
        if (document.readyState === "loading") { document.addEventListener("DOMContentLoaded", initApp); } else { initApp(); }
    </script>
</body>
</html>
